<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>Aeronautical Calculator – Mach · CAS · Altitude</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-main: #05070c;
            --bg-card: #0d141f;
            --bg-card-elevated: #111827;
            --bg-input: #111827;
            --bg-input-focus: #020617;
            --border-subtle: #1f2933;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.16);
            --accent-strong: #0ea5e9;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --danger: #f97373;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 60%, #000 100%);
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* הסרת החיצים של input number */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .card {
            width: 100%;
            max-width: 960px;
            background: radial-gradient(circle at top left, #111827 0, #020617 65%);
            border-radius: 18px;
            border: 1px solid #111827;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.8),
                0 0 0 1px rgba(15, 23, 42, 0.9);
            padding: 18px 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card-header {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .title-block {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-circle {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: radial-gradient(circle at 20% 0, #38bdf8, #0f172a 70%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
            box-shadow: 0 8px 20px rgba(56, 189, 248, 0.4);
        }

        .title-main {
            font-size: 1.15rem;
            font-weight: 600;
        }

        .title-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .solve-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* שלושת הפרמטרים */
        .tabs-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 6px;
        }

        .param-block {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* כפתור עליון עם הערך בפנים */
        .tab {
            width: 100%;
            padding: 8px 10px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: #020617;
            color: var(--text-muted);
            cursor: pointer;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 4px;
            transition: background 0.15s, border-color 0.15s, color 0.15s, box-shadow 0.15s;
        }

        .tab-label-row {
            display: flex;
            justify-content: center;
            align-items: baseline;
        }

        .tab span.main-label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* שני פרמטרי קלט – מסגרת תכלת */
        .tab.selected {
            border-color: var(--accent);
            background: radial-gradient(circle at top, #0b1120 0, #020617 55%);
            color: var(--text-main);
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
        }

        /* תיבת ערך בתוך הכפתור – גדולה ובולטת */
        .value-input {
            height: 34px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-input);
            color: var(--text-main);
            font-size: 1.15rem;
            font-weight: 600;
            padding: 4px 6px;
            text-align: center;
            outline: none;
            transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
            width: 100%;
        }

        .value-input:focus {
            border-color: var(--accent);
            background: var(--bg-input-focus);
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
        }

        .value-input:disabled {
            opacity: 0.7;
            cursor: default;
        }

        .unit-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 2px;
        }

        /* סליידרים – מוסתרים מהעין, נשארים לקוד */
        .param-slider {
            width: 100%;
            display: none;
        }

        .spin-buttons-row {
            display: flex;
            justify-content: center;
        }

        .spin-buttons {
            display: inline-flex;
            gap: 4px;
        }

        .spin-buttons button {
            width: 30px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.8rem;
            padding: 0;
            cursor: pointer;
        }

        .spin-buttons button:hover {
            border-color: #4b5563;
            background: #030712;
        }

        /* פרמטר שהוא תוצאה: לא מציג סליידר ולא חיצים */
        .param-block.output-param .param-slider,
        .param-block.output-param .spin-buttons-row {
            display: none !important;
        }

        /* חוגת Mach – גדולה יותר, כמעט ברוחב הכפתור */
        #machDial {
            display: block;
            margin: 6px auto 0 auto;
            width: 100%;
            max-width: 120px;
            height: auto;
            touch-action: none;
        }

        .primary-btn {
            border: none;
            border-radius: 999px;
            background: linear-gradient(90deg, #38bdf8, #0ea5e9);
            color: #020617;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 9px 26px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow:
                0 12px 30px rgba(56, 189, 248, 0.5),
                0 0 0 1px rgba(15, 23, 42, 0.9);
            text-align: center;
        }

        .primary-btn span.icon {
            font-size: 1rem;
        }

        .primary-btn:disabled {
            background: #030712;
            color: #6b7280;
            box-shadow: none;
            cursor: default;
            opacity: 0.9;
        }

        .form-rows {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            align-items: center;
        }

        .action-wrapper {
            display: flex;
            justify-content: center;
        }

        .result-box {
            margin-top: 8px;
            font-size: 0.82rem;
            background: #020617;
            border-radius: 10px;
            padding: 6px 8px;
            border: 1px solid #111827;
            color: var(--text-main);
            text-align: center;
        }

        .result-box b {
            color: var(--accent-strong);
        }

        #container {
            margin-top: 18px;
            width: 100%;
            max-width: 600px;
        }

        #machCanvas {
            border-radius: 10px;
            border: 1px solid #111827;
            background: #020617;
            width: 100%;
            height: auto;
            display: block;
        }

        #info {
            margin-top: 8px;
            font-size: 0.9rem;
            text-align: center;
            min-height: 1.2em;
        }

        #legend {
            margin-top: 4px;
            font-size: 0.8rem;
            opacity: 0.8;
            text-align: center;
        }

        #isaControl {
            margin-top: 4px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        #isaControl span {
            min-width: 40px;
            display: inline-block;
            text-align: left;
        }

        #isaSlider {
            width: 220px;
            max-width: 100%;
        }

        /* מובייל */
        @media (max-width: 480px) {
            body {
                padding: 12px 8px;
            }

            .card,
            #container {
                max-width: 360px;
                margin: 0 auto;
            }

            .tabs-row {
                gap: 6px;
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="card-header">
            <div class="title-block">
                <div class="icon-circle">✈️</div>
                <div>
                    <div class="title-main">Aeronautical Calculator</div>
                    <div class="title-sub">CAS · Mach · Altitude · TAS · ΔISA</div>
                </div>
            </div>

            <div class="solve-label" dir="rtl">
                בחר שני פרמטרים לקלט – השלישי יחושב עבורך, פרינצי:
            </div>
        </div>

        <!-- שלושת הפרמטרים: CAS / MACH / ALT -->
        <div class="tabs-row">
            <!-- CAS -->
            <div class="param-block" id="casWrapper">
                <button class="tab selected" id="tabCas" type="button">
                    <div class="tab-label-row">
                        <span class="main-label">CAS</span>
                    </div>
                    <input id="casInput" type="number" step="1" value="350" class="value-input">
                    <div class="unit-label">kt</div>
                </button>
                <!-- סליידר מוסתר, נשאר ללוגיקה -->
                <input id="casSlider" class="param-slider" type="range" min="150" max="700" step="10" value="350">
                <div class="spin-buttons-row">
                    <div class="spin-buttons" id="casSpin" data-target="casInput" data-step="10" data-min="150"
                        data-max="700">
                        <button type="button" class="spin-up">▲</button>
                        <button type="button" class="spin-down">▼</button>
                    </div>
                </div>
            </div>

            <!-- MACH -->
            <div class="param-block" id="machWrapper">
                <button class="tab selected" id="tabMach" type="button">
                    <div class="tab-label-row">
                        <span class="main-label">MACH</span>
                    </div>
                    <input id="machInput" type="number" step="0.01" value="0.80" class="value-input">
                    <div class="unit-label">M</div>
                </button>
                <!-- חוגה במקום סליידר -->
                <canvas id="machDial" width="120" height="120"></canvas>
                <!-- סליידר מוסתר למימוש פנימי -->
                <input id="machSlider" class="param-slider" type="range" min="0.6" max="1.2" step="0.01" value="0.80">
                <div class="spin-buttons-row">
                    <div class="spin-buttons" id="machSpin" data-target="machInput" data-step="0.01" data-min="0.6"
                        data-max="1.2">
                        <button type="button" class="spin-up">▲</button>
                        <button type="button" class="spin-down">▼</button>
                    </div>
                </div>
            </div>

            <!-- ALT -->
            <div class="param-block output-param" id="altWrapper">
                <button class="tab" id="tabAlt" type="button">
                    <div class="tab-label-row">
                        <span class="main-label">ALT</span>
                    </div>
                    <input id="altInput" type="number" step="100" value="23000" class="value-input" disabled>
                    <div class="unit-label">ft</div>
                </button>
                <input id="altSlider" class="param-slider" type="range" min="0" max="40000" step="1000" value="23000">
                <div class="spin-buttons-row">
                    <div class="spin-buttons" id="altSpin" data-target="altInput" data-step="1000" data-min="0"
                        data-max="40000">
                        <button type="button" class="spin-up">▲</button>
                        <button type="button" class="spin-down">▼</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-rows">
            <div id="isaControl">
                ISA
                <span id="isaValue">+0°C</span>
                <input type="range" id="isaSlider" min="-20" max="20" value="0">
            </div>

            <div class="form-row action-row">
                <div class="action-wrapper">
                    <button id="solveButton" class="primary-btn" disabled>
                        <span class="icon">✈️</span>
                        <span>ברשותך, ממריא בלי אישור</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="calcResult" class="result-box">
            Result will appear here…
        </div>
    </div>

    <div id="container">
        <canvas id="machCanvas"></canvas>
    </div>
    <div id="info">Move mouse or finger near a Mach line…</div>
    <div id="legend">
        Range: CAS 150–700 kt, Alt 0–40,000 ft. Pinch to zoom & pan, tap Mach lines to lock & drag point.
    </div>

    <script>
        // ==== Constants ====
        const T0 = 288.15;
        const P0 = 101325.0;
        const R = 287.05287;
        const G = 9.80665;
        const L = 0.0065;
        const GAMMA = 1.4;
        const FT_PER_M = 3.28084;

        const CAS_MIN = 150;
        const CAS_MAX = 700;
        const ALT_MIN = 0;
        const ALT_MAX = 40000;

        const machValues = [];
        for (let m = 0.6; m <= 1.2001; m += 0.1) {
            machValues.push(parseFloat(m.toFixed(1)));
        }
        const altStepFt = 2000;

        const canvas = document.getElementById('machCanvas');
        const ctx = canvas.getContext('2d');
        const infoDiv = document.getElementById('info');
        const isaSlider = document.getElementById('isaSlider');
        const isaValueSpan = document.getElementById('isaValue');
        const solveButton = document.getElementById('solveButton');
        const resultDiv = document.getElementById('calcResult');

        const marginLeft = 70;
        const marginRight = 25;
        const marginTop = 40;
        const marginBottom = 50;

        let machLinesData = [];
        let lockedPoint = null;
        let currentPoint = null;
        let highlightCasTick = null;
        let highlightAltTick = null;
        let isaDeviationC = 0;

        // view window (default)
        let viewCasMin = 300;
        let viewCasMax = 600;
        let viewAltMin = 10000;
        let viewAltMax = 30000;

        // dynamic tick steps
        let casMinorStep = 50, casLabelStep = 100;
        let altMinorStep = 1000, altLabelStep = 5000;

        // pinch / pan
        let pinchOrientation = null;
        let pinchStartDist = 0;
        let pinchStartViewCasMin = viewCasMin;
        let pinchStartViewCasMax = viewCasMax;
        let pinchStartViewAltMin = viewAltMin;
        let pinchStartViewAltMax = viewAltMax;
        let pinchStartMidCas = null;
        let pinchStartMidAlt = null;
        let lastTouchPos = null;
        let dragLockedTouch = false;

        // Mach dial
        let machDialCanvas = null;
        let machDialCtx = null;
        let machDialDragging = false;

        // solve mode – מי מחושב (output)
        // solveCas => CAS מחושב; קלט: MACH+ALT
        // solveMach => MACH מחושב; קלט: CAS+ALT
        // solveAlt => ALT מחושב; קלט: CAS+MACH
        let calcMode = "solveAlt";

        // רשימת שני הפרמטרים שנבחרו כקלט, לפי סדר הוותק
        // הערכים: 'CAS', 'MACH', 'ALT'
        let inputParams = ['CAS', 'MACH']; // ברירת מחדל – ALT תוצאה

        function setSolveEnabled(on) { solveButton.disabled = !on; }
        function markChanged() { setSolveEnabled(true); }

        // ===== Atmosphere / conversions =====
        function isaAtAltitude(hMeters) {
            let T, p;
            if (hMeters <= 11000.0) {
                T = T0 - L * hMeters;
                p = P0 * Math.pow(T / T0, G / (R * L));
            } else {
                const T11 = T0 - L * 11000.0;
                const p11 = P0 * Math.pow(T11 / T0, G / (R * L));
                T = T11;
                p = p11 * Math.exp(-G * (hMeters - 11000.0) / (R * T));
            }
            const rho = p / (R * T);
            const a = Math.sqrt(GAMMA * R * T);
            return { T, p, rho, a };
        }

        function casFromMachAndAlt(M, hMeters) {
            const atm = isaAtAltitude(hMeters);
            const p = atm.p;
            const qc = p * (Math.pow(1 + 0.2 * M * M, 3.5) - 1.0);
            const a0 = Math.sqrt(GAMMA * R * T0);
            const ptOverP0 = qc / P0 + 1.0;
            const Vc2 = 5 * a0 * a0 * (Math.pow(ptOverP0, 2.0 / 7.0) - 1.0);
            const Vc2pos = Math.max(Vc2, 0);
            const Vc = Math.sqrt(Vc2pos);
            return Vc / 0.514444;
        }

        function tasFromPoint(pt) {
            if (!pt) return null;
            const altM = pt.altFt / FT_PER_M;
            const atmISA = isaAtAltitude(altM);
            const T_actual = atmISA.T + isaDeviationC;
            const a_actual = Math.sqrt(GAMMA * R * T_actual);
            const tas_ms = pt.M * a_actual;
            return tas_ms / 0.514444;
        }

        function findAltitudeForCasAndMach(M, casTarget) {
            const hMin = ALT_MIN / FT_PER_M;
            const hMax = ALT_MAX / FT_PER_M;
            function f(h) { return casFromMachAndAlt(M, h) - casTarget; }

            let fMin = f(hMin), fMax = f(hMax);
            if (!isFinite(fMin) || !isFinite(fMax) || fMin * fMax > 0) return null;

            let lo = hMin, hi = hMax;
            for (let i = 0; i < 50; i++) {
                const mid = 0.5 * (lo + hi);
                const fMid = f(mid);
                if (fMin * fMid <= 0) { hi = mid; fMax = fMid; }
                else { lo = mid; fMin = fMid; }
            }
            return 0.5 * (lo + hi);
        }

        function solveMachGivenCasAlt(casTarget, altFt) {
            const altM = altFt / FT_PER_M;
            function f(M) { return casFromMachAndAlt(M, altM) - casTarget; }

            let lo = 0.1, hi = 2.0;
            let fLo = f(lo), fHi = f(hi);
            if (!isFinite(fLo) || !isFinite(fHi) || fLo * fHi > 0) return null;

            for (let i = 0; i < 60; i++) {
                const mid = 0.5 * (lo + hi);
                const fMid = f(mid);
                if (fLo * fMid <= 0) { hi = mid; fHi = fMid; }
                else { lo = mid; fLo = fMid; }
            }
            return 0.5 * (lo + hi);
        }

        // ==== Mach dial helpers ====
        function clampMachValue(val) {
            return Math.min(1.2, Math.max(0.6, val));
        }

        function getMachValue() {
            let M = parseFloat(document.getElementById('machInput').value);
            if (isNaN(M)) M = 0.8;
            return clampMachValue(M);
        }

        function drawMachDial() {
            if (!machDialCanvas || !machDialCtx) return;
            const ctxD = machDialCtx;
            const w = machDialCanvas.width;
            const h = machDialCanvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) / 2 - 6;

            ctxD.clearRect(0, 0, w, h);

            // רקע
            ctxD.fillStyle = "#020617";
            ctxD.fillRect(0, 0, w, h);

            // עיגול
            ctxD.beginPath();
            ctxD.arc(cx, cy, radius, 0, 2 * Math.PI);
            ctxD.fillStyle = "#0b1120";
            ctxD.fill();
            ctxD.strokeStyle = "#4b5563";
            ctxD.lineWidth = 2;
            ctxD.stroke();

            // טיקים (0.6–1.2 כל 0.1)
            ctxD.save();
            ctxD.translate(cx, cy);
            const minM = 0.6, maxM = 1.2;
            const sweepDeg = 270; // -135 .. +135
            for (let m = minM; m <= maxM + 1e-6; m += 0.1) {
                const frac = (m - minM) / (maxM - minM);
                const deg = -135 + frac * sweepDeg;
                const rad = deg * Math.PI / 180;
                const rOuter = radius - 4;
                const rInner = radius - 10;
                const x1 = rInner * Math.cos(rad);
                const y1 = rInner * Math.sin(rad);
                const x2 = rOuter * Math.cos(rad);
                const y2 = rOuter * Math.sin(rad);
                ctxD.beginPath();
                ctxD.moveTo(x1, y1);
                ctxD.lineTo(x2, y2);
                ctxD.strokeStyle = "#6b7280";
                ctxD.lineWidth = 1.2;
                ctxD.stroke();
            }

            // מחוג לפי Mach נוכחי
            const M = getMachValue();
            const frac = (M - minM) / (maxM - minM);
            const angleDeg = -135 + frac * sweepDeg;
            const angleRad = angleDeg * Math.PI / 180;
            const rNeedle = radius - 14;
            const nx = rNeedle * Math.cos(angleRad);
            const ny = rNeedle * Math.sin(angleRad);

            ctxD.beginPath();
            ctxD.moveTo(0, 0);
            ctxD.lineTo(nx, ny);
            ctxD.strokeStyle = "#38bdf8";
            ctxD.lineWidth = 2;
            ctxD.stroke();

            // מרכז
            ctxD.beginPath();
            ctxD.arc(0, 0, 4, 0, 2 * Math.PI);
            ctxD.fillStyle = "#38bdf8";
            ctxD.fill();

            // טקסט Mach
            ctxD.fillStyle = "#e5e7eb";
            ctxD.font = "11px system-ui";
            ctxD.textAlign = "center";
            ctxD.textBaseline = "middle";
            ctxD.fillText(M.toFixed(2) + " M", 0, radius * -0.4);

            ctxD.restore();
        }

        function machDialSetByPointer(clientX, clientY) {
            if (!machDialCanvas) return;
            const rect = machDialCanvas.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const dx = clientX - cx;
            const dy = clientY - cy;
            let angle = Math.atan2(dy, dx); // -π..π
            let deg = angle * 180 / Math.PI;

            // תחום הדיאל: -135..+135
            if (deg < -135) deg = -135;
            if (deg > 135) deg = 135;

            const frac = (deg + 135) / 270;
            let M = 0.6 + frac * (1.2 - 0.6);
            M = Math.round(M * 100) / 100; // קוונטות 0.01

            const machInput = document.getElementById('machInput');
            const machSlider = document.getElementById('machSlider');
            machInput.value = M.toFixed(2);
            if (machSlider) machSlider.value = M;

            drawMachDial();
            markChanged();
        }

        // ==== coordinate transforms ====
